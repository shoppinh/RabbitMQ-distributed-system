services:
  postgres-order:
    image: postgres:16-alpine
    container_name: postgres-order
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: order_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_order_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d order_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-payment:
    image: postgres:16-alpine
    container_name: postgres-payment
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: payment_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_payment_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d payment_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-inventory:
    image: postgres:16-alpine
    container_name: postgres-inventory
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: inventory_db
    ports:
      - "5435:5432"
    volumes:
      - postgres_inventory_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d inventory_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  db-migrator-order:
    image: node:20-alpine
    container_name: db-migrator-order
    working_dir: /app
    depends_on:
      postgres-order:
        condition: service_healthy
    environment:
      DB_HOST: postgres-order
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: order_db
      MIGRATIONS_DIR: database/migrations/order
    volumes:
      - .:/app
    command: sh -c "npm install --omit=dev && node scripts/migrate.js"
    restart: "no"

  db-migrator-payment:
    image: node:20-alpine
    container_name: db-migrator-payment
    working_dir: /app
    depends_on:
      postgres-payment:
        condition: service_healthy
    environment:
      DB_HOST: postgres-payment
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: payment_db
      MIGRATIONS_DIR: database/migrations/payment
    volumes:
      - .:/app
    command: sh -c "npm install --omit=dev && node scripts/migrate.js"
    restart: "no"

  db-migrator-inventory:
    image: node:20-alpine
    container_name: db-migrator-inventory
    working_dir: /app
    depends_on:
      postgres-inventory:
        condition: service_healthy
    environment:
      DB_HOST: postgres-inventory
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: inventory_db
      MIGRATIONS_DIR: database/migrations/inventory
    volumes:
      - .:/app
    command: sh -c "npm install --omit=dev && node scripts/migrate.js"
    restart: "no"

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  order-service:
    build:
      context: .
      dockerfile: order-service/Dockerfile
    container_name: order-service
    depends_on:
      db-migrator-order:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    environment:
      OTEL_SERVICE_NAME: "order-service"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "otel-collector:4317"
      PORT: 3000
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      ORDER_EXCHANGE: order.topic
      DB_HOST: postgres-order
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: order_db
      SAGA_TIMEOUT_MS: 90000
      TIMEOUT_CHECK_INTERVAL_MS: 10000
    ports:
      - "3000:3000"
    restart: unless-stopped

  payment-service:
    build:
      context: .
      dockerfile: payment-service/Dockerfile
    container_name: payment-service
    depends_on:
      db-migrator-payment:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    environment:
      OTEL_SERVICE_NAME: "payment-service"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "otel-collector:4317"
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      ORDER_EXCHANGE: order.topic
      DB_HOST: postgres-payment
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: payment_db
      PREFETCH_COUNT: 1
      RETRY_DELAY_MS: 5000
      MAX_RETRIES: 3
      PAYMENT_QUEUE: payment_queue
      PAYMENT_RETRY_QUEUE: payment_retry_queue
      PAYMENT_DLQ: payment_dlq
      PAYMENT_FAILURE_RATE: 0.3
      PAYMENT_PROCESSING_MS: 600
      OUTBOX_POLL_INTERVAL_MS: 1000
    restart: unless-stopped

  inventory-service:
    build:
      context: .
      dockerfile: inventory-service/Dockerfile
    container_name: inventory-service
    depends_on:
      db-migrator-inventory:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    environment:
      OTEL_SERVICE_NAME: "inventory-service"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "otel-collector:4317"
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      ORDER_EXCHANGE: order.topic
      DB_HOST: postgres-inventory
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: inventory_db
      PREFETCH_COUNT: 1
      RETRY_DELAY_MS: 5000
      MAX_RETRIES: 3
      INVENTORY_QUEUE: inventory_queue
      INVENTORY_RETRY_QUEUE: inventory_retry_queue
      INVENTORY_DLQ: inventory_dlq
      INVENTORY_FAILURE_RATE: 0.2
      INVENTORY_PROCESSING_MS: 300
      OUTBOX_POLL_INTERVAL_MS: 1000
    restart: unless-stopped

  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      OTEL_SERVICE_NAME: "notification-service"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "otel-collector:4317"
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      ORDER_EXCHANGE: order.topic
      PREFETCH_COUNT: 1
      RETRY_DELAY_MS: 5000
      MAX_RETRIES: 3
      NOTIFICATION_QUEUE: notification_queue
      NOTIFICATION_RETRY_QUEUE: notification_retry_queue
      NOTIFICATION_DLQ: notification_dlq
      NOTIFICATION_PROCESSING_MS: 250
    restart: unless-stopped

  otel-collector:
    image: otel/opentelemetry-collector:0.96.0
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./config/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "8889:8889" # Prometheus metrics endpoint
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.50.1
    container_name: prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --enable-feature=otlp-write-receiver
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    restart: unless-stopped

  tempo:
    image: grafana/tempo:2.4.0
    container_name: tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./config/tempo.yaml:/etc/tempo.yaml
      - tempo_data:/tmp/tempo
    ports:
      - "3200:3200" # Tempo
    restart: unless-stopped

  loki:
    image: grafana/loki:3.4.1
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./config/loki-local-config.yaml:/etc/loki/local-config.yaml
      - loki_data:/loki
    ports:
      - "3100:3100"
    restart: unless-stopped

  promtail:
    image: grafana/promtail:3.4.1
    container_name: promtail
    volumes:
      - ./config/promtail.yaml:/etc/promtail/promtail.yaml
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/promtail.yaml
    depends_on:
      - loki
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.3.3
    container_name: grafana
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - ./config/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - grafana_data:/var/lib/grafana
    ports:
      - "3001:3000"
    depends_on:
      - loki
      - prometheus
      - tempo
    restart: unless-stopped

volumes:
  rabbitmq_data:
  postgres_order_data:
  postgres_payment_data:
  postgres_inventory_data:
  prometheus_data:
  tempo_data:
  grafana_data:
  loki_data:
